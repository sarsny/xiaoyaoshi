<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ç”¨è¯ç®¡ç† MVP åŸå‹</title>
    <!-- å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥å›¾æ ‡åº“ (Heroicons) -->
    <script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>
    <style>
        /* åŸºç¡€æ ·å¼ï¼Œä½¿ç”¨ Inter å­—ä½“ */
        body {
            font-family: 'Inter', 'Helvetica Neue', 'Hiragino Sans GB', 'WenQuanYi Micro Hei', 'Microsoft YaHei', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        /* å¼ºåˆ¶æé†’çš„ Z-index */
        #reminderModal {
            z-index: 9999;
        }
        /* éšè—çš„è§†å›¾ */
        .view {
            display: none;
        }
        /* æ¿€æ´»çš„è§†å›¾ */
        .view.active {
            display: block;
        }
        /* ç®€å•çš„åŠ è½½åŠ¨ç”» */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 max-w-lg mx-auto h-[90vh] overflow-hidden shadow-lg rounded-lg mt-4 border border-gray-300">

    <!-- ä¸»å®¹å™¨ -->
    <div class="flex flex-col h-full">

        <!-- é¡¶éƒ¨å¯¼èˆª (æ¨¡æ‹Ÿ) -->
        <header class="bg-white shadow-sm sticky top-0 z-10">
            <div class="max-w-lg mx-auto px-4 py-4 flex justify-between items-center">
                <h1 id="viewTitle" class="text-xl font-bold text-gray-800">æˆ‘çš„ç”¨è¯</h1>
                <button class="text-gray-600">
                    <ion-icon name="person-circle-outline" class="text-3xl"></ion-icon>
                </button>
            </div>
        </header>

        <!-- ä¸»å†…å®¹åŒº -->
        <main class="flex-1 overflow-y-auto p-4 pb-20">

            <!-- è§†å›¾ 1: é¦–é¡µ (ç”¨è¯æ—¶é—´è¡¨) -->
            <div id="homeView" class="view">
                <div class="bg-white p-4 rounded-lg shadow mb-4">
                    <h2 class="text-lg font-semibold text-gray-700 mb-2">ä»Šæ—¥ç”¨è¯ - 11æœˆ6æ—¥ (å‘¨å››)</h2>
                    <p class="text-sm text-gray-500">æ‚¨ä»Šæ—¥æœ‰ 3 é¡¹ç”¨è¯è®¡åˆ’ã€‚</p>
                </div>

                <!-- æ—¶é—´çº¿ -->
                <div id="medicationList" class="space-y-4">
                    <!-- åŠ¨æ€æ¸²æŸ“çš„è¯ç‰©é¡¹å°†æ’å…¥è¿™é‡Œ -->
                    <div class="flex items-center space-x-3 p-4 bg-white rounded-lg shadow opacity-50">
                        <ion-icon name="time-outline" class="text-3xl text-gray-400"></ion-icon>
                        <div class="flex-1 cursor-pointer" onclick="showMedDetail(0)">
                            <p class="font-semibold text-gray-500 line-through">08:00 (é¤å)</p>
                            <p class="text-gray-700 line-through">è‹¯ç£ºé…¸æ°¨æ°¯åœ°å¹³ç‰‡ (5mg, 1ç‰‡)</p>
                        </div>
                        <div class="flex items-center space-x-2 text-green-600">
                            <ion-icon name="checkmark-circle" class="text-2xl"></ion-icon>
                            <span class="font-medium">å·²æœç”¨</span>
                        </div>
                    </div>
                    
                    <div class="flex items-center space-x-3 p-4 bg-white rounded-lg shadow border-l-4 border-blue-500">
                        <ion-icon name="alarm-outline" class="text-3xl text-blue-600"></ion-icon>
                        <div class="flex-1 cursor-pointer" onclick="showMedDetail(1)">
                            <p class="font-semibold text-blue-700">12:00 (é¤å‰)</p>
                            <p class="text-gray-800">äºŒç”²åŒèƒç¼“é‡Šç‰‡ (0.5g, 1ç‰‡)</p>
                        </div>
                        <button class="bg-blue-600 text-white px-3 py-1 rounded-full text-sm font-medium shadow-md" onclick="confirmIntake(1); event.stopPropagation();">ç¡®è®¤æœç”¨</button>
                    </div>

                    <div class="flex items-center space-x-3 p-4 bg-white rounded-lg shadow">
                        <ion-icon name="moon-outline" class="text-3xl text-gray-600"></ion-icon>
                        <div class="flex-1 cursor-pointer" onclick="showMedDetail(2)">
                            <p class="font-semibold text-gray-700">20:00 (ç¡å‰)</p>
                            <p class="text-gray-800">é˜¿æ‰˜ä¼ä»–æ±€é’™ç‰‡ (20mg, 1ç‰‡)</p>
                        </div>
                    </div>
                    <!-- æ–°å¢ï¼šæ¨¡æ‹ŸAIæŒ‰8å°æ—¶é—´éš”æ’ç¨‹ -->
                    <div class="flex items-center space-x-3 p-4 bg-white rounded-lg shadow">
                        <ion-icon name="hourglass-outline" class="text-3xl text-gray-600"></ion-icon>
                        <div class="flex-1 cursor-pointer" onclick="showMedDetail(3)">
                            <p class="font-semibold text-gray-700">23:00 (é—´éš”8å°æ—¶)</p>
                            <p class="text-gray-800">æ¨¡æ‹ŸæŠ—ç”Ÿç´  (1ç²’)</p>
                        </div>
                    </div>
                </div>

                <!-- 
                    ä¿®å¤ï¼šè¿™ä¸ªæŠ¥å‘Šé¢„è§ˆå—è¢«ç§»é™¤äº†ï¼Œå› ä¸ºå®ƒä¸åº•éƒ¨çš„â€œæŠ¥å‘Šâ€å¯¼èˆªé‡å¤äº†
                    <div class="mt-6">
                        ...
                    </div> 
                -->
            </div>

            <!-- è§†å›¾ 2: æ·»åŠ /ç¼–è¾‘è¡¨å• -->
            <div id="formView" class="view">
                <div class="bg-white p-6 rounded-lg shadow">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">æ·»åŠ è¯ç‰©</h2>
                    <form id="medForm" class="space-y-4">
                        <div>
                            <label for="medName" class="block text-sm font-medium text-gray-700">è¯ç‰©åç§°</label>
                            <input type="text" id="medName" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                        </div>
                        <div>
                            <label for="medDosage" class="block text-sm font-medium text-gray-700">å‰‚é‡</label>
                            <input type="text" id="medDosage" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" placeholder="ä¾‹å¦‚: 5mg, 1ç‰‡" required>
                        </div>
                        <div>
                            <label for="medTime" class="block text-sm font-medium text-gray-700">æœè¯æ—¶é—´</label>
                            <input type="time" id="medTime" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
                        </div>
                        <div>
                            <label for="medInstruction" class="block text-sm font-medium text-gray-700">æœç”¨è¯´æ˜</label>
                            <input type="text" id="medInstruction" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" placeholder="ä¾‹å¦‚: é¤å, ç¡å‰">
                        </div>
                        <div class="flex justify-end space-x-2 pt-4">
                            <button type="button" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md" onclick="showView('homeView')">å–æ¶ˆ</button>
                            <button type="button" class="px-4 py-2 bg-blue-600 text-white rounded-md shadow" onclick="saveMedication()">ä¿å­˜</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- è§†å›¾ 3: æ‰«æåŠ è½½ä¸­ -->
            <div id="loadingView" class="view">
                <div class="flex flex-col items-center justify-center h-64">
                    <div class="loader"></div>
                    <p class="mt-4 text-gray-600 font-medium">æ­£åœ¨è¯†åˆ«å¤„æ–¹ä¿¡æ¯...</p>
                    <p class="text-sm text-gray-500">AI æ­£åœ¨ä¸ºæ‚¨ç»“æ„åŒ–ç”¨è¯æ•°æ®</p>
                </div>
            </div>

            <!-- è§†å›¾ 5: é¦–æ¬¡ä½¿ç”¨è®¾ç½® (Onboarding) -->
            <div id="onboardingView" class="view">
                <div class="bg-white p-6 rounded-lg shadow space-y-4">
                    <h2 class="text-xl font-bold text-gray-800 text-center">æ¬¢è¿ä½¿ç”¨ AI ç”¨è¯åŠ©æ‰‹</h2>
                    <p class="text-gray-600 text-center text-sm">ä¸ºäº†ç»™æ‚¨åˆ¶å®šç§‘å­¦çš„ç”¨è¯è®¡åˆ’ï¼Œè¯·å…ˆè®¾ç½®æ‚¨çš„æ—¥å¸¸ä½œæ¯æ—¶é—´ã€‚</p>
                    
                    <div>
                        <label for="wakeTime" class="block text-sm font-medium text-gray-700">èµ·åºŠæ—¶é—´</label>
                        <input type="time" id="wakeTime" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" value="07:00">
                    </div>
                    <div>
                        <label for="breakfastTime" class="block text-sm font-medium text-gray-700">æ—©é¤æ—¶é—´</label>
                        <input type="time" id="breakfastTime" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" value="07:30">
                    </div>
                    <div>
                        <label for="lunchTime" class="block text-sm font-medium text-gray-700">åˆé¤æ—¶é—´</label>
                        <input type="time" id="lunchTime" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" value="12:00">
                    </div>
                    <div>
                        <label for="dinnerTime" class="block text-sm font-medium text-gray-700">æ™šé¤æ—¶é—´</label>
                        <input type="time" id="dinnerTime" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" value="18:30">
                    </div>
                    <div>
                        <label for="sleepTime" class="block text-sm font-medium text-gray-700">ç¡è§‰æ—¶é—´</label>
                        <input type="time" id="sleepTime" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" value="23:00">
                    </div>
                    <div class="pt-4">
                        <button type="button" class="w-full px-4 py-3 bg-blue-600 text-white rounded-md shadow font-medium" onclick="saveOnboarding()">å®Œæˆè®¾ç½®ï¼Œå¼€å§‹ä½¿ç”¨</button>
                    </div>
                </div>
            </div>

            <!-- è§†å›¾ 6: å¤šææ–™æ‰«æä¸Šä¼  -->
            <div id="scanUploadView" class="view">
                <div class="bg-white p-6 rounded-lg shadow space-y-6">
                    <h2 class="text-xl font-bold text-gray-800 text-center">æ™ºèƒ½è¯†åˆ«</h2>
                    <p class="text-gray-600 text-center text-sm">è¯·ä¾æ¬¡æ‹æ‘„ä»¥ä¸‹ææ–™ï¼ŒAI å°†ç»¼åˆåˆ†æå¹¶ä¸ºæ‚¨ç”Ÿæˆæœ€å‡†ç¡®çš„ç”¨è¯è®¡åˆ’ã€‚</p>
                    
                    <!-- æ¨¡æ‹Ÿä¸Šä¼ é¡¹ç›® -->
                    <div class="space-y-4">
                        <div id="uploadStep1" class="flex items-center justify-between p-4 bg-gray-50 rounded-lg border">
                            <div>
                                <p class="font-medium text-gray-700">1. å¤„æ–¹å•</p>
                                <p class="text-sm text-gray-500">åŒ»ç”Ÿå¼€å…·çš„å¤„æ–¹</p>
                            </div>
                            <button class="bg-blue-500 text-white px-4 py-2 rounded-md text-sm font-medium flex items-center" onclick="simulateUpload('uploadStep1')">
                                <ion-icon name="camera-outline" class="mr-1"></ion-icon>
                                æ‹ç…§
                            </button>
                        </div>
                        
                        <div id="uploadStep2" class="flex items-center justify-between p-4 bg-gray-50 rounded-lg border">
                            <div>
                                <p class="font-medium text-gray-700">2. è¯æˆ¿æ ‡ç­¾</p>
                                <p class="text-sm text-gray-500">è´´åœ¨è¯ç›’ä¸Šçš„ç”¨è¯æŒ‡å¼•</p>
                            </div>
                            <button class="bg-blue-500 text-white px-4 py-2 rounded-md text-sm font-medium flex items-center" onclick="simulateUpload('uploadStep2')">
                                <ion-icon name="camera-outline" class="mr-1"></ion-icon>
                                æ‹ç…§
                            </button>
                        </div>

                        <div id="uploadStep3" class="flex items-center justify-between p-4 bg-gray-50 rounded-lg border">
                            <div>
                                <p class="font-medium text-gray-700">3. è¯å“è¯´æ˜ä¹¦</p>
                                <p class="text-sm text-gray-500">è¯ç›’å†…é™„çš„è¯¦ç»†è¯´æ˜</p>
                            </div>
                            <button class="bg-blue-500 text-white px-4 py-2 rounded-md text-sm font-medium flex items-center" onclick="simulateUpload('uploadStep3')">
                                <ion-icon name="camera-outline" class="mr-1"></ion-icon>
                                æ‹ç…§
                            </button>
                        </div>
                    </div>
                    
                    <div class="pt-4">
                        <button id="startAnalysisBtn" type="button" class="w-full px-4 py-3 bg-gray-400 text-white rounded-md shadow font-medium" disabled onclick="startAiAnalysis()">
                            è¯·å…ˆå®Œæˆä¸Šä¼ 
                        </button>
                    </div>
                </div>
            </div>

            <!-- æ–°å¢è§†å›¾ 7: å¥åº·æŠ¥å‘Š -->
            <div id="reportView" class="view">
                <div class="space-y-6">
                    <!-- 1. æ€»ä½“ä¾ä»æ€§ -->
                    <div class="bg-white p-6 rounded-lg shadow text-center">
                        <p class="text-sm font-medium text-gray-500">æœ¬æœˆæ€»ä½“ä¾ä»æ€§</p>
                        <p id="reportOverallAdherence" class="text-5xl font-bold text-green-600 mt-2">95%</p>
                        <p class="text-sm text-gray-600 mt-2">ç»§ç»­ä¿æŒï¼Œæ‚¨çš„åšæŒæ˜¯å¥åº·çš„åŸºç¡€ï¼</p>
                    </div>

                    <!-- 2. æœˆåº¦æ—¥å† (æ¨¡æ‹Ÿ) -->
                    <div class="bg-white p-4 rounded-lg shadow">
                        <h3 class="text-lg font-semibold text-gray-700 mb-4 text-center">2025å¹´ 11æœˆ æœè¯æ—¥å†</h3>
                        <div id="reportCalendar" class="grid grid-cols-7 gap-2">
                            <!-- JS åŠ¨æ€ç”Ÿæˆæ—¥å† -->
                        </div>
                        <div class="flex justify-center space-x-4 mt-4 text-xs text-gray-500">
                            <span class="flex items-center"><span class="w-3 h-3 bg-green-500 rounded-full mr-1"></span>åœ†æ»¡</span>
                            <span class="flex items-center"><span class="w-3 h-3 bg-yellow-400 rounded-full mr-1"></span>éƒ¨åˆ†</span>
                            <span class="flex items-center"><span class="w-3 h-3 bg-gray-300 rounded-full mr-1"></span>ç¼ºæ¼</span>
                        </div>
                    </div>

                    <!-- 3. è¯ç‰©ä¾ä»æ€§æ˜ç»† -->
                    <div class="bg-white rounded-lg shadow">
                        <h3 class="text-lg font-semibold text-gray-700 p-4 border-b">è¯ç‰©ä¾ä»æ€§è¯¦æƒ…</h3>
                        <ul id="reportMedList" class="divide-y divide-gray-200">
                            <!-- JS åŠ¨æ€ç”Ÿæˆåˆ—è¡¨ -->
                        </ul>
                    </div>
                </div>
            </div>

            <!-- æ–°å¢è§†å›¾ 8: AI æ™ºèƒ½æ’ç¨‹å»ºè®® (æ ¸å¿ƒä»ªå¼æ„Ÿ) -->
            <div id="aiReasoningView" class="view">
                <div class="bg-white p-6 rounded-lg shadow space-y-5">
                    <h2 class="text-xl font-bold text-gray-800 text-center">AI æ™ºèƒ½æ’ç¨‹å»ºè®®</h2>
                    
                    <!-- AI è¯†åˆ«çš„è¯ç‰©ä¿¡æ¯ -->
                    <div class="flex items-center space-x-4 p-4 bg-gray-50 rounded-lg">
                        <img id="reasoningMedImage" src="https://placehold.co/400x300/FFEEEE/C53030?text=é˜¿å¸åŒ¹æ—è‚ æº¶ç‰‡" alt="è¯å“å›¾ç‰‡" class="w-20 h-20 object-cover rounded-lg bg-gray-200 flex-shrink-0">
                        <div class="flex-1">
                            <p id="reasoningMedName" class="text-lg font-semibold text-gray-800">é˜¿å¸åŒ¹æ—è‚ æº¶ç‰‡</p>
                            <p id="reasoningMedInfo" class="text-gray-600">100mg, 1ç‰‡</p>
                        </div>
                    </div>

                    <!-- AI æ¨èç†ç”± (æ ¸å¿ƒ) -->
                    <div class="bg-yellow-50 border border-yellow-300 rounded-lg p-4">
                        <p class="text-sm font-medium text-yellow-800">AI æ¨èç†ç”±ï¼š</p>
                        <p id="aiReasoningText" class="text-sm text-yellow-700 mt-1">æ ¹æ®â€œé¤åâ€åŒ»å˜±å’Œæ‚¨ 07:30 çš„æ—©é¤æ—¶é—´ï¼ŒAI æ¨èæ­¤æ—¶æœç”¨ã€‚</p>
                    </div>
                    
                    <!-- ç”¨æˆ·å¾®è°ƒåŒº -->
                    <div>
                        <label for="reasoningMedTime" class="block text-sm font-medium text-gray-700">æœè¯æ—¶é—´ (æ‚¨å¯å¾®è°ƒ)</label>
                        <input type="time" id="reasoningMedTime" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" value="07:30">
                    </div>
                    <div>
                        <label for="reasoningMedInstruction" class="block text-sm font-medium text-gray-700">æœç”¨è¯´æ˜ (æ‚¨å¯å¾®è°ƒ)</label>
                        <input type="text" id="reasoningMedInstruction" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" value="é¤å">
                    </div>
                    
                    <!-- æ“ä½œæŒ‰é’® -->
                    <div class="flex justify-between space-x-2 pt-4">
                        <button type="button" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md w-1/2" onclick="showView('scanUploadView')">
                            <ion-icon name="arrow-back-outline" class="mr-1"></ion-icon>
                            é‡æ–°æ‰«æ
                        </button>
                        <button type="button" class="px-4 py-2 bg-blue-600 text-white rounded-md shadow w-1/2" onclick="saveFromReasoning()">
                            ç¡®è®¤å¹¶ä¿å­˜
                        </button>
                    </div>
                </div>
            </div>


        </main>

        <!-- åº•éƒ¨å¯¼èˆªæ  (æ¨¡æ‹Ÿ) -->
        <footer class="bg-white shadow-inner sticky bottom-0 z-10 border-t border-gray-200">
            <nav class="max-w-lg mx-auto px-6 py-3 flex justify-around items-center">
                <button id="navHomeBtn" class="flex flex-col items-center text-blue-600" onclick="showView('homeView')">
                    <ion-icon name="home" class="text-2xl"></ion-icon>
                    <span class="text-xs">é¦–é¡µ</span>
                </button>
                
                <!-- æ ¸å¿ƒï¼šæ·»åŠ è¯ç‰©æŒ‰é’® -->
                <button class="transform -translate-y-6 bg-blue-600 text-white p-4 rounded-full shadow-lg" onclick="showModal('addMedModal')">
                    <ion-icon name="camera-outline" class="text-3xl"></ion-icon>
                </button>
                
                <button id="navReportBtn" class="flex flex-col items-center text-gray-500" onclick="showView('reportView')">
                    <ion-icon name="document-text-outline" class="text-2xl"></ion-icon>
                    <span class="text-xs">æŠ¥å‘Š</span>
                </button>
            </nav>
        </footer>
    </div>

    <!-- å¼¹çª— Modals -->

    <!-- å¼¹çª— 1: æ·»åŠ è¯ç‰©æ–¹å¼é€‰æ‹© -->
    <div id="addMedModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-sm p-6 space-y-4">
            <h3 class="text-lg font-semibold text-center">æ·»åŠ è¯ç‰©</h3>
            <button class="w-full flex items-center justify-center p-4 bg-blue-600 text-white rounded-lg shadow" onclick="simulateScan()">
                <ion-icon name="camera" class="text-2xl mr-3"></ion-icon>
                <span class="font-medium">æ‹ç…§ / æ‰«ç è¯†åˆ«</span>
            </button>
            <button class="w-full flex items-center justify-center p-4 bg-gray-100 text-gray-700 rounded-lg" onclick="manualAdd()">
                <ion-icon name="create-outline" class="text-2xl mr-3"></ion-icon>
                <span class="font-medium">æ‰‹åŠ¨è¾“å…¥</span>
            </button>
            <button class="mt-4 w-full text-center text-gray-500" onclick="hideModal('addMedModal')">å–æ¶ˆ</button>
        </div>
    </div>

    <!-- å¼¹çª— 2: é£é™©æç¤º (æ ¸å¿ƒåŠŸèƒ½) -->
    <div id="riskAlertModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-sm p-6">
            <div class="flex flex-col items-center">
                <ion-icon name="warning" class="text-7xl text-yellow-500"></ion-icon>
                <h3 class="text-xl font-bold text-gray-800 mt-4">ç”¨è¯é£é™©æç¤º</h3>
                <p id="riskAlertMessage" class="text-gray-600 text-center mt-2 mb-6">
                    <!-- æ¶ˆæ¯å°†ç”± JS åŠ¨æ€æ’å…¥ -->
                </p>
                <p class="text-sm text-red-600 font-bold mb-4">è¯·ç«‹å³å’¨è¯¢æ‚¨çš„åŒ»ç”Ÿæˆ–è¯å‰‚å¸ˆï¼</p>
                <button class="w-full p-3 bg-red-600 text-white rounded-lg font-medium shadow" onclick="hideModal('riskAlertModal')">
                    æˆ‘å·²çŸ¥æ™“
                </button>
            </div>
        </div>
    </div>

    <!-- å¼¹çª— 3: æœè¯æé†’ (æ ¸å¿ƒåŠŸèƒ½) -->
    <div id="reminderModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-sm p-6">
            <div class="text-center">
                <ion-icon name="alarm" class="text-7xl text-blue-600 animate-pulse"></ion-icon>
                <h3 class="text-2xl font-bold text-gray-800 mt-4">è¯¥åƒè¯å•¦ï¼</h3>
                <p class="text-gray-600 text-lg mt-2">ç°åœ¨æ˜¯ <span id="reminderTime"></span></p>
                <div class="bg-blue-50 p-4 rounded-lg my-6 border border-blue-200">
                    <!-- æ–°å¢ï¼šè¯å“å›¾ç‰‡ -->
                    <img id="reminderMedImage" src="" alt="è¯å“å›¾ç‰‡" class="w-full h-40 object-cover rounded-lg mb-4 bg-gray-200">
                    <p class="text-xl font-semibold text-blue-800" id="reminderMedName"></p>
                    <p class="text-md text-blue-700" id="reminderMedInfo"></p>
                    <!-- æ–°å¢ï¼šæ¨¡æ‹Ÿè¯­éŸ³æ’­æŠ¥æç¤º -->
                    <p class="text-xs text-gray-500 mt-2 flex items-center justify-center">
                        <ion-icon name="volume-medium-outline" class="mr-1"></ion-icon>
                        (æ¨¡æ‹Ÿè¯­éŸ³): "è¯¥åƒè¯å•¦..."
                    </p>
                </div>
                <div class="flex space-x-4">
                    <button class="w-1/2 p-3 bg-gray-200 text-gray-700 rounded-lg font-medium" onclick="hideModal('reminderModal')">
                        ç¨åæé†’
                    </button>
                    <button class="w-1/2 p-3 bg-green-600 text-white rounded-lg font-medium shadow" onclick="confirmIntakeFromReminder()">
                        æˆ‘å·²æœç”¨
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- å¼¹çª— 4: è¯å“è¯¦æƒ… (æ–°åŠŸèƒ½) -->
    <div id="medDetailModal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden z-40">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-sm p-6 space-y-4">
            <img id="medDetailImage" src="" alt="è¯å“å›¾ç‰‡" class="w-full h-48 object-cover rounded-lg bg-gray-200">
            <h3 id="medDetailName" class="text-xl font-bold text-gray-800"></h3>
            
            <div>
                <p class="text-sm font-medium text-gray-500">ç”¨è¯ä¿¡æ¯</p>
                <p id="medDetailInfo" class="text-gray-700"></p>
            </div>

            <!-- æ–°å¢ï¼šå‰¯ä½œç”¨æé†’ -->
            <div>
                <p class="text-sm font-medium text-gray-500">å¸¸è§å‰¯ä½œç”¨</p>
                <p id="medDetailSideEffect" class="text-gray-700 bg-yellow-50 border border-yellow-200 rounded-md p-2"></p>
            </div>

            <button class="mt-4 w-full text-center p-2 bg-blue-600 text-white rounded-lg font-medium" onclick="hideModal('medDetailModal')">
                å…³é—­
            </button>
        </div>
    </div>

    <!-- æ–°å¢ å¼¹çª— 5: æœè¯è¡¨æ‰¬ (æ–°åŠŸèƒ½) -->
    <div id="praiseModal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-sm p-8 text-center">
            <div class="text-6xl mb-4">ğŸ‘</div>
            <h3 class="text-xl font-bold text-gray-800">å¤ªæ£’äº†ï¼</h3>
            <p class="text-gray-600 mt-2">æ‚¨å·²æŒ‰æ—¶æœç”¨ <span id="praiseMedName" class="font-medium"></span>ï¼</p>
            <p class="text-gray-600 mt-1">å¥½å¥½åƒè¯ï¼Œèº«ä½“æ£’æ£’ï¼</p>
        </div>
    </div>


    <script>
        // --- çŠ¶æ€ç®¡ç† (æ¨¡æ‹Ÿæ•°æ®åº“) ---
        const appState = {
            currentView: 'onboardingView', // é»˜è®¤å¯åŠ¨é¡µæ”¹ä¸º Onboarding
            isFirstTime: true, // æ ‡è®°æ˜¯å¦é¦–æ¬¡ä½¿ç”¨
            // æ–°å¢ï¼šè¿½è¸ªä¸Šä¼ çŠ¶æ€
            uploadStatus: {
                step1: false,
                step2: false,
                step3: false
            },
            userProfile: {
                wakeTime: '07:00',
                breakfastTime: '07:30',
                lunchTime: '12:00',
                dinnerTime: '18:30',
                sleepTime: '23:00'
            },
            medications: [
                { id: 0, name: 'è‹¯ç£ºé…¸æ°¨æ°¯åœ°å¹³ç‰‡', dosage: '5mg, 1ç‰‡', time: '07:30', instruction: 'é¤å', taken: true, sideEffect: 'å¸¸è§ï¼šå¤´ç—›ã€æ°´è‚¿', imageUrl: 'https://placehold.co/400x300/EBF8FF/3182CE?text=è‹¯ç£ºé…¸æ°¨æ°¯åœ°å¹³ç‰‡' },
                { id: 1, name: 'äºŒç”²åŒèƒç¼“é‡Šç‰‡', dosage: '0.5g, 1ç‰‡', time: '12:00', instruction: 'é¤å‰', taken: false, sideEffect: 'å¸¸è§ï¼šè…¹æ³»ã€æ¶å¿ƒã€èƒƒè‚ èƒ€æ°”', imageUrl: 'https://placehold.co/400x300/FEFEEB/D69E2E?text=äºŒç”²åŒèƒç¼“é‡Šç‰‡' },
                { id: 2, name: 'é˜¿æ‰˜ä¼ä»–æ±€é’™ç‰‡', dosage: '20mg, 1ç‰‡', time: '20:00', instruction: 'ç¡å‰', taken: false, sideEffect: 'ç½•è§ï¼šè‚Œè‚‰ç–¼ç—›ã€è‚é…¶å‡é«˜', imageUrl: 'https://placehold.co/400x300/F0FFF4/38A169?text=é˜¿æ‰˜ä¼ä»–æ±€é’™ç‰‡' },
                // æ¨¡æ‹Ÿâ€œä¸€æ—¥ä¸‰æ¬¡â€æŒ‰8å°æ—¶é—´éš”æ’ç¨‹
                { id: 3, name: 'æ¨¡æ‹ŸæŠ—ç”Ÿç´ ', dosage: '1ç²’', time: '07:00', instruction: 'é—´éš”8å°æ—¶', taken: false, sideEffect: 'éµåŒ»å˜±', imageUrl: 'https://placehold.co/400x300/E9D8FD/805AD5?text=æ¨¡æ‹ŸæŠ—ç”Ÿç´ (7ç‚¹)' },
                { id: 4, name: 'æ¨¡æ‹ŸæŠ—ç”Ÿç´ ', dosage: '1ç²’', time: '15:00', instruction: 'é—´éš”8å°æ—¶', taken: false, sideEffect: 'éµåŒ»å˜±', imageUrl: 'https://placehold.co/400x300/E9D8FD/805AD5?text=æ¨¡æ‹ŸæŠ—ç”Ÿç´ (15ç‚¹)' },
                { id: 5, name: 'æ¨¡æ‹ŸæŠ—ç”Ÿç´ ', dosage: '1ç²’', time: '23:00', instruction: 'é—´éš”8å°æ—¶', taken: false, sideEffect: 'éµåŒ»å˜±', imageUrl: 'https://placehold.co/400x300/E9D8FD/805AD5?text=æ¨¡æ‹ŸæŠ—ç”Ÿç´ (23ç‚¹)' }
            ],
            // æ–°å¢ï¼šæ¨¡æ‹ŸæŠ¥å‘Šæ•°æ®
            reportData: {
                overallAdherence: 95,
                calendar: [
                    { day: 1, status: 'full' }, { day: 2, status: 'full' }, { day: 3, status: 'full' },
                    { day: 4, status: 'partial' }, { day: 5, status: 'full' }, { day: 6, status: 'full' }, { day: 7, status: 'full' },
                    { day: 8, status: 'full' }, { day: 9, status: 'full' }, { day: 10, status: 'missed' }, { day: 11, status: 'full' },
                    { day: 12, status: 'full' }, { day: 13, status: 'full' }, { day: 14, status: 'full' },
                    // ... æ¨¡æ‹Ÿæ›´å¤šæ•°æ® ...
                    { day: 15, status: 'full' }, { day: 16, status: 'full' }, { day: 17, status: 'partial' }, { day: 18, status: 'full' },
                    { day: 19, status: 'full' }, { day: 20, status: 'full' }, { day: 21, status: 'full' },
                    { day: 22, status: 'full' }, { day: 23, status: 'full' }, { day: 24, status: 'full' }, { day: 25, status: 'full' },
                    { day: 26, status: 'missed' }, { day: 27, status: 'full' }, { day: 28, status: 'full' }, { day: 29, status: 'full' }, { day: 30, status: 'full' }
                ],
                byMed: [
                    { name: 'è‹¯ç£ºé…¸æ°¨æ°¯åœ°å¹³ç‰‡', adherence: 98 },
                    { name: 'äºŒç”²åŒèƒç¼“é‡Šç‰‡', adherence: 92 },
                    { name: 'é˜¿æ‰˜ä¼ä»–æ±€é’™ç‰‡', adherence: 100 },
                    { name: 'æ¨¡æ‹ŸæŠ—ç”Ÿç´ ', adherence: 88 }
                ]
            }
        };

        // --- ä¿®å¤ï¼šæ¢å¤æ‰€æœ‰ç¼ºå¤±çš„ JS å‡½æ•° ---

        // ç”¨äºå­˜å‚¨ AI æ‰«æçš„ä¸´æ—¶æ•°æ®ï¼ˆåŒ…æ‹¬å‰¯ä½œç”¨å’Œå›¾ç‰‡ï¼‰
        let simulatedScanData = null;
        let tempMedData = {}; // ç”¨äºæ‰‹åŠ¨æ·»åŠ æ—¶æš‚å­˜

        // --- é¡µé¢åŠ è½½å®Œæˆæ—¶åˆå§‹åŒ– ---
        document.addEventListener('DOMContentLoaded', () => {
            // æ£€æŸ¥æ˜¯å¦é¦–æ¬¡åŠ è½½
            if (appState.isFirstTime) {
                showView('onboardingView');
            } else {
                showView('homeView');
                renderMedicationList();
            }
            
            // æ¨¡æ‹Ÿä¸€ä¸ª3ç§’åçš„æé†’ï¼Œæ¼”ç¤ºæ ¸å¿ƒåŠŸèƒ½
            setTimeout(() => {
                // æ‰¾åˆ°ä¸€ä¸ªæœªæœç”¨çš„è¯æ¥æé†’
                const medToRemind = appState.medications.find(m => !m.taken);
                if (medToRemind) {
                    showReminder(medToRemind); // æé†’
                }
            }, 3000);
        });

        // --- è§†å›¾åˆ‡æ¢ ---
        function showView(viewId) {
            // éšè—æ‰€æœ‰è§†å›¾
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            // æ˜¾ç¤ºç›®æ ‡è§†å›¾
            const view = document.getElementById(viewId);
            if (view) {
                view.classList.add('active');
            }
            appState.currentView = viewId;
            
            // æ›´æ–°æ ‡é¢˜
            if (viewId === 'homeView') document.getElementById('viewTitle').textContent = 'æˆ‘çš„ç”¨è¯';
            if (viewId === 'formView') document.getElementById('viewTitle').textContent = 'æ·»åŠ è¯ç‰©';
            if (viewId === 'onboardingView') document.getElementById('viewTitle').textContent = 'æ¬¢è¿ä½¿ç”¨';
            if (viewId === 'scanUploadView') document.getElementById('viewTitle').textContent = 'æ™ºèƒ½è¯†åˆ«';
            if (viewId === 'aiReasoningView') document.getElementById('viewTitle').textContent = 'AI æ’ç¨‹å»ºè®®'; // æ–°å¢
            if (viewId === 'reportView') { // æ–°å¢
                document.getElementById('viewTitle').textContent = 'å¥åº·æŠ¥å‘Š';
                renderReportView(); // æ¸²æŸ“æŠ¥å‘Š
            }

            // æ›´æ–°åº•éƒ¨å¯¼èˆªé«˜äº®
            const homeBtn = document.getElementById('navHomeBtn');
            const reportBtn = document.getElementById('navReportBtn');
            // ä¿®å¤ï¼šä¸»é¡µæŒ‰é’®åœ¨ç›¸å…³æµç¨‹è§†å›¾ï¼ˆè¡¨å•ã€æ‰«æã€åŠ è½½ï¼‰ä¸­ä¹Ÿåº”ä¿æŒé«˜äº®
            const homeRelatedViews = ['homeView', 'formView', 'scanUploadView', 'loadingView', 'onboardingView', 'aiReasoningView']; // æ–°å¢ aiReasoningView
            homeBtn.classList.toggle('text-blue-600', homeRelatedViews.includes(viewId));
            homeBtn.classList.toggle('text-gray-500', !homeRelatedViews.includes(viewId));
            reportBtn.classList.toggle('text-blue-600', viewId === 'reportView');
            reportBtn.classList.toggle('text-gray-500', viewId !== 'reportView');
        }

        // --- å¼¹çª—æ§åˆ¶ ---
        function showModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) modal.classList.remove('hidden');
        }

        function hideModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) modal.classList.add('hidden');
        }

        // --- æ ¸å¿ƒåŠŸèƒ½ï¼šæ¸²æŸ“ç”¨è¯åˆ—è¡¨ ---
        function renderMedicationList() {
            const listEl = document.getElementById('medicationList');
            listEl.innerHTML = ''; // æ¸…ç©ºåˆ—è¡¨

            // ç®€å•æ’åºï¼šæœªæœç”¨çš„åœ¨å‰
            const sortedMeds = [...appState.medications].sort((a, b) => a.taken - b.taken);

            sortedMeds.forEach(med => {
                const isTaken = med.taken;
                const itemClass = isTaken ? 'opacity-60' : '';
                const iconName = isTaken ? 'checkmark-circle-outline' : (med.instruction.includes('é¤') ? 'restaurant-outline' : (med.instruction.includes('ç¡') ? 'moon-outline' : 'alarm-outline'));
                const timeColor = isTaken ? 'text-gray-500' : 'text-blue-700';
                const textClass = isTaken ? 'line-through text-gray-500' : 'text-gray-800';

                // æŸ¥æ‰¾å…·æœ‰ç›¸åŒåç§°å’Œä¸åŒæ—¶é—´çš„è¯ç‰©ï¼ˆç”¨äºåˆå¹¶æ˜¾ç¤ºï¼‰
                // è¿™æ˜¯ä¸€ä¸ªç®€åŒ–çš„æ¨¡æ‹Ÿï¼ŒçœŸå®çš„å®ç°ä¼šæ›´å¤æ‚
                if (med.name === 'æ¨¡æ‹ŸæŠ—ç”Ÿç´ ' && med.time !== '07:00') {
                    // æš‚æ—¶è·³è¿‡ï¼Œåªæ˜¾ç¤ºç¬¬ä¸€ä¸ª
                    if (med.time === '15:00') {
                        const firstMedEl = listEl.querySelector('[data-med-id="3"] .med-time');
                        if(firstMedEl) firstMedEl.textContent += ', 15:00, 23:00';
                    }
                    return; 
                }

                let medEl = `
                    <div class="flex items-center space-x-3 p-4 bg-white rounded-lg shadow ${itemClass}" data-med-id="${med.id}">
                        <ion-icon name="${iconName}" class="text-3xl ${isTaken ? 'text-gray-400' : 'text-gray-700'}"></ion-icon>
                        
                        <!-- ä¿®æ”¹ï¼šæ·»åŠ  onclick="showMedDetail" å’Œ cursor-pointer -->
                        <div class="flex-1 cursor-pointer" onclick="showMedDetail(${med.id})">
                            <p class="font-semibold ${isTaken ? 'text-gray-500 line-through' : timeColor} med-time">
                                ${med.time} (${med.instruction})
                            </p>
                            <p class="${textClass}">${med.name} (${med.dosage})</p>
                        </div>
                `;

                // åˆå¹¶â€œä¸€æ—¥ä¸‰æ¬¡â€çš„æŒ‰é’®çŠ¶æ€
                if (med.name === 'æ¨¡æ‹ŸæŠ—ç”Ÿç´ ') {
                     const taken1 = med.taken;
                     const taken2 = appState.medications.find(m => m.id === 4).taken;
                     const taken3 = appState.medications.find(m => m.id === 5).taken;

                     if (taken1 && taken2 && taken3) {
                         medEl += `
                         <div class="flex items-center space-x-2 text-green-600">
                            <ion-icon name="checkmark-circle" class="text-2xl"></ion-icon>
                            <span class="font-medium">å·²æœç”¨(3/3)</span>
                         </div>`;
                     } else {
                         // ç®€åŒ–åŸå‹ï¼Œåªæ˜¾ç¤ºç¬¬ä¸€ä¸ªæŒ‰é’®
                         medEl += `
                         <button class="bg-blue-600 text-white px-3 py-1 rounded-full text-sm font-medium shadow-md" onclick="confirmIntake(${med.id}); event.stopPropagation();">
                            ç¡®è®¤ ${med.time}
                         </button>`;
                     }
                }
                else if (isTaken) {
                    medEl += `
                        <div class="flex items-center space-x-2 text-green-600">
                            <ion-icon name="checkmark-circle" class="text-2xl"></ion-icon>
                            <span class="font-medium">å·²æœç”¨</span>
                        </div>
                        `;
                } else {
                    medEl += `
                        <!-- ä¿®æ”¹ï¼šæ·»åŠ  event.stopPropagation() é˜²æ­¢ç‚¹å‡»æŒ‰é’®æ—¶è§¦å‘è¯¦æƒ…å¼¹çª— -->
                        <button class="bg-blue-600 text-white px-3 py-1 rounded-full text-sm font-medium shadow-md" onclick="confirmIntake(${med.id}); event.stopPropagation();">
                            ç¡®è®¤æœç”¨
                        </button>
                        `;
                }
                
                medEl += `</div>`;
                listEl.innerHTML += medEl;
            });
        }

        // --- æ ¸å¿ƒåŠŸèƒ½ï¼šæ¨¡æ‹Ÿ OCR æ‰«æ ---
        function simulateScan() {
            hideModal('addMedModal');
            // é‡ç½®ä¸Šä¼ çŠ¶æ€
            appState.uploadStatus = { step1: false, step2: false, step3: false };
            
            // é‡ç½®ä¸Šä¼ é¡µé¢UI (é˜²æ­¢ç”¨æˆ·ä¸­é€”é€€å‡º)
            ['uploadStep1', 'uploadStep2', 'uploadStep3'].forEach(id => {
                 const el = document.getElementById(id);
                 const button = el.querySelector('button');
                 button.classList.remove('bg-green-600');
                 button.classList.add('bg-blue-500');
                 button.innerHTML = '<ion-icon name="camera-outline" class="mr-1"></ion-icon> æ‹ç…§';
                 button.disabled = false;
            });
            const analysisBtn = document.getElementById('startAnalysisBtn');
            analysisBtn.disabled = true;
            analysisBtn.classList.add('bg-gray-400');
            analysisBtn.classList.remove('bg-blue-600');
            analysisBtn.textContent = 'è¯·å…ˆå®Œæˆä¸Šä¼ ';

            showView('scanUploadView'); // æ˜¾ç¤ºæ–°çš„ä¸Šä¼ è§†å›¾
        }

        // --- æ–°åŠŸèƒ½ï¼šæ¨¡æ‹Ÿå•ä¸ªæ–‡ä»¶ä¸Šä¼  ---
        function simulateUpload(stepId) {
            const el = document.getElementById(stepId);
            const button = el.querySelector('button');
            const icon = '<ion-icon name="checkmark-circle" class="mr-1"></ion-icon>';
            
            button.classList.remove('bg-blue-500');
            button.classList.add('bg-green-600');
            button.innerHTML = icon + 'å·²ä¸Šä¼ ';
            button.disabled = true;

            if (stepId === 'uploadStep1') appState.uploadStatus.step1 = true;
            if (stepId === 'uploadStep2') appState.uploadStatus.step2 = true;
            if (stepId === 'uploadStep3') appState.uploadStatus.step3 = true;

            // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰é¡¹éƒ½å·²ä¸Šä¼ 
            checkAllUploaded();
        }

        // --- æ–°åŠŸèƒ½ï¼šæ£€æŸ¥ä¸Šä¼ çŠ¶æ€ ---
        function checkAllUploaded() {
            const { step1, step2, step3 } = appState.uploadStatus;
            const analysisBtn = document.getElementById('startAnalysisBtn');
            // å¿…é¡»ä¸‰é¡¹éƒ½â€œä¸Šä¼ â€
            if (step1 && step2 && step3) {
                analysisBtn.disabled = false;
                analysisBtn.classList.remove('bg-gray-400');
                analysisBtn.classList.add('bg-blue-600');
                analysisBtn.textContent = 'å¼€å§‹æ™ºèƒ½åˆ†æ';
            }
        }

        // --- æ–°åŠŸèƒ½ï¼šå¼€å§‹ AI åˆ†æ (åŸ simulateScan çš„ååŠéƒ¨åˆ†) ---
        function startAiAnalysis() {
            showView('loadingView'); // æ˜¾ç¤ºåŠ è½½è§†å›¾

            // æ¨¡æ‹Ÿ2ç§’é’Ÿçš„ AI è¯†åˆ«
            // TODO: åœ¨çœŸå®åº”ç”¨ä¸­ï¼Œè¿™é‡Œä¼šè°ƒç”¨ AI (Gemini) API
            setTimeout(() => {
                // æ¨¡æ‹Ÿè¯†åˆ«ç»“æœ (æ–°å¢å‰¯ä½œç”¨å’Œå›¾ç‰‡)
                // ** æ¨¡æ‹ŸAIæ™ºèƒ½æ’ç¨‹ **
                // å‡è®¾ AI è¯†åˆ«åˆ°â€œé¤åâ€ï¼Œå®ƒä¼šæŸ¥çœ‹ç”¨æˆ·çš„æ—©é¤æ—¶é—´ (07:30)
                const proposedTime = appState.userProfile.breakfastTime; // 
                
                const mockData = {
                    name: 'é˜¿å¸åŒ¹æ—è‚ æº¶ç‰‡',
                    dosage: '100mg, 1ç‰‡',
                    time: proposedTime, // AI æ™ºèƒ½æ¨èäº† 07:30
                    instruction: 'é¤å',
                    sideEffect: 'å¸¸è§ï¼šèƒƒè‚ é“ä¸é€‚ã€å‡ºè¡€é£é™©',
                    imageUrl: 'https://placehold.co/400x300/FFEEEE/C53030?text=é˜¿å¸åŒ¹æ—è‚ æº¶ç‰‡'
                };

                // å­˜å‚¨æ¨¡æ‹Ÿæ•°æ®ï¼Œä»¥ä¾¿ä¿å­˜æ—¶ä½¿ç”¨
                simulatedScanData = mockData;

                // å¡«å……è¡¨å• (æ—§æµç¨‹)
                // document.getElementById('medName').value = mockData.name;
                // document.getElementById('medDosage').value = mockData.dosage;
                // document.getElementById('medTime').value = mockData.time;
                // document.getElementById('medInstruction').value = mockData.instruction;
                
                // showView('formView'); // æ˜¾ç¤ºå¡«å……å¥½çš„è¡¨å• (æ—§æµç¨‹)

                // --- æ–°æµç¨‹ï¼šå¡«å…… AI å»ºè®®è§†å›¾ ---
                document.getElementById('reasoningMedImage').src = mockData.imageUrl;
                document.getElementById('reasoningMedName').textContent = mockData.name;
                document.getElementById('reasoningMedInfo').textContent = mockData.dosage;
                
                // åŠ¨æ€ç”Ÿæˆç†ç”±
                const reasonText = `æ ¹æ®â€œ${mockData.instruction}â€åŒ»å˜±å’Œæ‚¨ ${appState.userProfile.breakfastTime} çš„æ—©é¤æ—¶é—´ï¼ŒAI æ¨èæ­¤æ—¶æœç”¨ã€‚`;
                document.getElementById('aiReasoningText').textContent = reasonText;
                
                document.getElementById('reasoningMedTime').value = mockData.time;
                document.getElementById('reasoningMedInstruction').value = mockData.instruction;
                
                showView('aiReasoningView'); // <-- æ˜¾ç¤ºæ–°çš„å»ºè®®è§†å›¾
            }, 2000);
        }

        // --- æ ¸å¿ƒåŠŸèƒ½ï¼šæ‰‹åŠ¨æ·»åŠ  ---
        function manualAdd() {
            hideModal('addMedModal');
            // æ¸…ç©ºè¡¨å•
            document.getElementById('medForm').reset();
            // æ¸…ç©ºä¸´æ—¶æ•°æ®
            simulatedScanData = null; 
            tempMedData = {};
            showView('formView');
        }

        // --- æ ¸å¿ƒåŠŸèƒ½ï¼šä¿å­˜è¯ç‰© (æ‰‹åŠ¨è¡¨å•) ---
        function saveMedication() {
            // ä»è¡¨å•è·å–æ•°æ®
            const newMed = {
                id: appState.medications.length, // ç®€å• ID
                name: document.getElementById('medName').value,
                dosage: document.getElementById('medDosage').value,
                time: document.getElementById('medTime').value,
                instruction: document.getElementById('medInstruction').value,
                taken: false,
                // å¦‚æœæ˜¯æ‰«æçš„ï¼Œå°±ä½¿ç”¨æ‰«æçš„æ•°æ®
                sideEffect: simulatedScanData ? simulatedScanData.sideEffect : 'è¯·éµåŒ»å˜±',
                imageUrl: simulatedScanData ? simulatedScanData.imageUrl : `https://placehold.co/400x300/EEEEEE/AAAAAA?text=${document.getElementById('medName').value}`
            };

            // æ¸…ç©ºæ‰«ææ•°æ®
            simulatedScanData = null;

            // æ£€æŸ¥è¯ç‰©ç›¸äº’ä½œç”¨ (æ¨¡æ‹Ÿ)
            const riskMessage = checkInteractions(newMed);
            
            if (riskMessage) {
                document.getElementById('riskAlertMessage').textContent = riskMessage;
                showModal('riskAlertModal');
                // é£é™©æç¤ºåï¼Œæˆ‘ä»¬ä»ç„¶æ·»åŠ è¯ç‰©ï¼Œä½†ç”¨æˆ·å·²è¢«è­¦å‘Š
            }

            appState.medications.push(newMed);
            renderMedicationList();
            showView('homeView');
        }

        // --- æ–°å¢åŠŸèƒ½ï¼šä» AI å»ºè®®è§†å›¾ä¿å­˜ ---
        function saveFromReasoning() {
            // ä» AI è§†å›¾å’Œç¼“å­˜çš„æ‰«ææ•°æ®ä¸­è·å–ä¿¡æ¯
            const newMed = {
                id: appState.medications.length, // ç®€å• ID
                name: simulatedScanData.name, // æ¥è‡ª AI æ‰«æ
                dosage: simulatedScanData.dosage, // æ¥è‡ª AI æ‰«æ
                time: document.getElementById('reasoningMedTime').value, // æ¥è‡ªç”¨æˆ·å¾®è°ƒ
                instruction: document.getElementById('reasoningMedInstruction').value, // æ¥è‡ªç”¨æˆ·å¾®è°ƒ
                taken: false,
                sideEffect: simulatedScanData.sideEffect, // æ¥è‡ª AI æ‰«æ
                imageUrl: simulatedScanData.imageUrl // æ¥è‡ª AI æ‰«æ
            };
            
            // æ¸…ç©ºæ‰«ææ•°æ®
            simulatedScanData = null;

            // æ£€æŸ¥è¯ç‰©ç›¸äº’ä½œç”¨ (æ¨¡æ‹Ÿ)
            const riskMessage = checkInteractions(newMed);
            
            if (riskMessage) {
                document.getElementById('riskAlertMessage').textContent = riskMessage;
                showModal('riskAlertModal');
                // é£é™©æç¤ºåï¼Œæˆ‘ä»¬ä»ç„¶æ·»åŠ è¯ç‰©ï¼Œä½†ç”¨æˆ·å·²è¢«è­¦å‘Š
            }

            appState.medications.push(newMed);
            renderMedicationList();
            showView('homeView');
        }

        // --- æ ¸å¿ƒåŠŸèƒ½ï¼šæ¨¡æ‹Ÿè¯ç‰©ç›¸äº’ä½œç”¨æ£€æŸ¥ ---
        function checkInteractions(newMed) {
            const existingMeds = appState.medications.map(m => m.name.toLowerCase());
            const newMedName = newMed.name.toLowerCase();
            let alertMsg = '';

            if (newMedName.includes('é˜¿å¸åŒ¹æ—') && existingMeds.some(m => m.includes('å¸ƒæ´›èŠ¬'))) {
                alertMsg = 'ä¸­åº¦é£é™©ï¼šé˜¿å¸åŒ¹æ—ä¸å¸ƒæ´›èŠ¬åŒç”¨å¯èƒ½å¢åŠ èƒƒè‚ é“å‡ºè¡€é£é™©ã€‚';
            }
            if (newMedName.includes('å¸ƒæ´›èŠ¬') && existingMeds.some(m => m.includes('é˜¿å¸åŒ¹æ—'))) {
                alertMsg = 'ä¸­åº¦é£é™©ï¼šå¸ƒæ´›èŠ¬ä¸é˜¿å¸åŒ¹æ—åŒç”¨å¯èƒ½å¢åŠ èƒƒè‚ é“å‡ºè¡€é£é™©ã€‚';
            }
            if (newMedName.includes('åæ³•æ—') && existingMeds.some(m => m.includes('é˜¿å¸åŒ¹æ—'))) {
                alertMsg = 'é«˜é£é™©æç¤ºï¼šåæ³•æ—ä¸é˜¿å¸åŒ¹æ—åŒç”¨ä¼šæ˜¾è‘—å¢åŠ å‡ºè¡€é£é™©ï¼';
            }
            if (newMedName.includes('é˜¿å¸åŒ¹æ—') && existingMeds.some(m => m.includes('åæ³•æ—'))) {
                alertMsg = 'é«˜é£é™©æç¤ºï¼šé˜¿å¸åŒ¹æ—ä¸åæ³•æ—åŒç”¨ä¼šæ˜¾è‘—å¢åŠ å‡ºè¡€é£é™©ï¼';
            }

            return alertMsg; // è¿”å›é£é™©ä¿¡æ¯
        }

        // --- æ ¸å¿ƒåŠŸèƒ½ï¼šç¡®è®¤æœè¯ ---
        function confirmIntake(medId) {
            const med = appState.medications.find(m => m.id === medId);
            if (med && !med.taken) {
                med.taken = true;
                showPraise(med.name); // <-- æ–°å¢ï¼šæ˜¾ç¤ºè¡¨æ‰¬å¼¹çª—
            }
            renderMedicationList();
        }

        // --- æ ¸å¿ƒåŠŸèƒ½ï¼šæ˜¾ç¤ºæœè¯æé†’ ---
        function showReminder(med) {
            if (med.taken) return; // å·²æœç”¨åˆ™ä¸æé†’

            document.getElementById('reminderTime').textContent = med.time;
            document.getElementById('reminderMedName').textContent = med.name;
            document.getElementById('reminderMedInfo').textContent = `${med.dosage} (${med.instruction})`;
            document.getElementById('reminderMedImage').src = med.imageUrl;
            document.getElementById('reminderModal').dataset.medId = med.id; // å­˜å‚¨ID
            
            showModal('reminderModal');
        }

        // --- ä»æé†’ä¸­ç¡®è®¤æœè¯ ---
        function confirmIntakeFromReminder() {
            const medId = parseInt(document.getElementById('reminderModal').dataset.medId);
            confirmIntake(medId);
            hideModal('reminderModal');
        }

        // --- æ–°åŠŸèƒ½ï¼šæ˜¾ç¤ºè¯å“è¯¦æƒ…å¼¹çª— ---
        function showMedDetail(medId) {
            const med = appState.medications.find(m => m.id === medId);
            if (!med) return;

            // å¡«å……æ•°æ®
            document.getElementById('medDetailImage').src = med.imageUrl;
            document.getElementById('medDetailName').textContent = med.name;
            document.getElementById('medDetailInfo').textContent = `${med.dosage} / ${med.time} (${med.instruction})`;
            document.getElementById('medDetailSideEffect').textContent = med.sideEffect || 'æš‚æ— ä¿¡æ¯';

            // æ˜¾ç¤ºå¼¹çª—
            showModal('medDetailModal');
        }

        // --- æ–°åŠŸèƒ½ï¼šä¿å­˜ Onboarding è®¾ç½® ---
        function saveOnboarding() {
            appState.userProfile.wakeTime = document.getElementById('wakeTime').value;
            appState.userProfile.breakfastTime = document.getElementById('breakfastTime').value;
            appState.userProfile.lunchTime = document.getElementById('lunchTime').value;
            appState.userProfile.dinnerTime = document.getElementById('dinnerTime').value;
            appState.userProfile.sleepTime = document.getElementById('sleepTime').value;
            
            appState.isFirstTime = false;
            
            // TODO: åœ¨çœŸå®åº”ç”¨ä¸­ï¼Œéœ€è¦æ ¹æ®æ–°æ—¶é—´é‡æ–°è®¡ç®—ç”¨è¯è®¡åˆ’
            // åœ¨åŸå‹ä¸­ï¼Œæˆ‘ä»¬åªæ˜¯ä¿å­˜å¹¶è·³è½¬
            
            showView('homeView');
            renderMedicationList();
        }

        // --- æ–°åŠŸèƒ½ï¼šæ˜¾ç¤ºè¡¨æ‰¬å¼¹çª— ---
        function showPraise(medName) {
            document.getElementById('praiseMedName').textContent = medName;
            showModal('praiseModal');
            
            // 2ç§’åè‡ªåŠ¨éšè—
            setTimeout(() => {
                hideModal('praiseModal');
            }, 2000);
        }

        // --- æ–°åŠŸèƒ½ï¼šæ¸²æŸ“æŠ¥å‘Šé¡µé¢ ---
        function renderReportView() {
            const { overallAdherence, calendar, byMed } = appState.reportData;

            // 1. å¡«å……æ€»ä½“ä¾ä»æ€§
            document.getElementById('reportOverallAdherence').textContent = `${overallAdherence}%`;

            // 2. å¡«å……æ—¥å†
            const calendarEl = document.getElementById('reportCalendar');
            calendarEl.innerHTML = ''; // æ¸…ç©º
            // æ¨¡æ‹Ÿæ—¥å†å‰ç©ºå‡ å¤©
            const firstDayOffset = 3; // å‡è®¾1å·æ˜¯å‘¨å››
            for (let i = 0; i < firstDayOffset; i++) {
                calendarEl.innerHTML += `<div class="w-8 h-8"></div>`;
            }
            // å¡«å……æ—¥æœŸ
            calendar.forEach(day => {
                let bgColor = 'bg-gray-300'; // ç¼ºæ¼
                if (day.status === 'full') bgColor = 'bg-green-500';
                if (day.status === 'partial') bgColor = 'bg-yellow-400';
                
                calendarEl.innerHTML += `
                    <div class="w-8 h-8 flex items-center justify-center ${bgColor} text-white text-xs rounded-full font-medium">
                        ${day.day}
                    </div>
                `;
            });

            // 3. å¡«å……è¯ç‰©åˆ—è¡¨
            const medListEl = document.getElementById('reportMedList');
            medListEl.innerHTML = ''; // æ¸…ç©º
            byMed.forEach(med => {
                let progressColor = 'bg-green-600';
                if (med.adherence < 95) progressColor = 'bg-yellow-500';
                if (med.adherence < 90) progressColor = 'bg-red-500';

                medListEl.innerHTML += `
                    <li class="p-4 space-y-2">
                        <div class="flex justify-between items-center">
                            <span class="font-medium text-gray-700">${med.name}</span>
                            <span class="font-bold ${progressColor.replace('bg-', 'text-')}">${med.adherence}%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="${progressColor} h-2 rounded-full" style="width: ${med.adherence}%"></div>
                        </div>
                    </li>
                `;
            });
        }

        // --- ä¿®å¤ï¼šæ¢å¤ document.addEventListener ---
        document.addEventListener('DOMContentLoaded', () => {
            // æ£€æŸ¥æ˜¯å¦é¦–æ¬¡åŠ è½½
            if (appState.isFirstTime) {
                showView('onboardingView');
            } else {
                showView('homeView');
                renderMedicationList();
            }
            
            // æ¨¡æ‹Ÿä¸€ä¸ª3ç§’åçš„æé†’ï¼Œæ¼”ç¤ºæ ¸å¿ƒåŠŸèƒ½
            setTimeout(() => {
                // æ‰¾åˆ°ä¸€ä¸ªæœªæœç”¨çš„è¯æ¥æé†’
                const medToRemind = appState.medications.find(m => !m.taken);
                if (medToRemind) {
                    showReminder(medToRemind); // æé†’
                }
            }, 3000);

            // ä¿®å¤ï¼šé¦–æ¬¡åŠ è½½æ—¶ï¼Œé¦–é¡µå¯èƒ½æœªæ¸²æŸ“
            if (!appState.isFirstTime) {
                 renderMedicationList();
            }
            // ä¿®å¤ï¼šç§»é™¤é¦–é¡µçš„æŠ¥å‘Šé¢„è§ˆå—
            const homeReportPreview = document.querySelector('#homeView .mt-6');
            if (homeReportPreview) {
                homeReportPreview.remove();
            }
        });

    </script>
</body>
</html>
